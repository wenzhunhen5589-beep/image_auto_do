import os
import random
import subprocess
import time
from PIL import Image


class AndroidComfuc:
    # adb命令输入封装
    def __init__(self, sn, image=(os.path.join(os.path.dirname(__file__), "screenshot.png"))):
        self.sn = sn
        self.image = image

    def shell(self, command, type=0, _timeout=600):
        try:
            res = subprocess.Popen("adb -s %s %s" % (self.sn, command), shell=True,
                                   stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            result = res.communicate(timeout=_timeout)
        except:
            return _timeout
        if type == 0:
            return result[0].decode('UTF-8', 'ignore').strip()
        return result

    def input_keyevent(self, keyworkds):
        self.shell("shell input keyevent %s" % keyworkds)

    # getevent获取动作属性值
    def send_keyevent(self, key_list, dev_event="event2"):
        self.shell("shell sendevent /dev/input/%s %s %s %s" % (dev_event, key_list[0], key_list[1], key_list[2]))

    def resized(self):
        key_list = [
            [1, 29, 1],
            [0, 0, 0],
            [3, 57, 64],
            [1, 330, 1],
            [3, 58, 2],
            [3, 53, 577],
            [3, 54, 158],
            [0, 0, 0],
            [3, 47, 1],
            [3, 57, 65],
            [3, 53, 391],
            [3, 54, 344],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 574],
            [3, 54, 160],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 393],
            [3, 54, 341],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 587],
            [3, 54, 162],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 395],
            [3, 54, 338],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 568],
            [3, 54, 164],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 397],
            [3, 54, 335],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 565],
            [3, 54, 166],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 399],
            [3, 54, 332],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 562],
            [3, 54, 168],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 401],
            [3, 54, 329],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 559],
            [3, 54, 170],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 403],
            [3, 54, 326],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 556],
            [3, 54, 172],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 405],
            [3, 54, 323],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 553],
            [3, 54, 174],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 407],
            [3, 54, 320],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 550],
            [3, 54, 176],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 409],
            [3, 54, 317],
            [0, 0, 0],
            [3, 47, 0],
            [3, 57, -1],
            [0, 0, 0],
            [3, 47, 1],
            [3, 57, -1],
            [1, 330, 0],
            [0, 0, 0],
            [3, 47, 0],
            [3, 57, 66],
            [1, 330, 1],
            [3, 53, 577],
            [3, 54, 158],
            [0, 0, 0],
            [3, 47, 1],
            [3, 57, 67],
            [3, 53, 391],
            [3, 54, 344],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 574],
            [3, 54, 160],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 393],
            [3, 54, 341],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 587],
            [3, 54, 162],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 395],
            [3, 54, 338],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 568],
            [3, 54, 164],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 397],
            [3, 54, 335],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 565],
            [3, 54, 166],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 399],
            [3, 54, 332],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 562],
            [3, 54, 168],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 401],
            [3, 54, 329],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 559],
            [3, 54, 170],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 403],
            [3, 54, 326],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 556],
            [3, 54, 172],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 405],
            [3, 54, 323],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 553],
            [3, 54, 174],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 407],
            [3, 54, 320],
            [0, 0, 0],
            [3, 47, 0],
            [3, 53, 550],
            [3, 54, 176],
            [0, 0, 0],
            [3, 47, 1],
            [3, 53, 409],
            [3, 54, 317],
            [0, 0, 0],
            [3, 47, 0],
            [3, 57, -1],
            [0, 0, 0],
            [3, 47, 1],
            [3, 57, -1],
            [1, 330, 0],
            [0, 0, 0],
            [1, 29, 0],
            [0, 0, 0],
        ]
        for i in key_list:
            self.send_keyevent(i)

    def click(self, point):
        x = int(point[0])
        y = int(point[1])
        self.shell("shell input tap %s %s" % (x, y))

    def swipe(self, start, end):
        swipe_time = random.randint(200, 500)
        self.shell(
            "shell input swipe %s %s %s %s %s" % (int(start[0]), int(start[1]), int(end[0]), int(end[1]), 600))

    # 手机截图导出
    def screenshot(self):
        self.shell("exec-out screencap -p > %s" % self.image)

    def get_center_pos(self):
        self.screenshot()
        image = Image.open(self.image)
        width, height = image.size
        # result = self.shell("shell wm size")
        # width, height = result.
        center_coordinate = [width / 2, height / 2]
        return center_coordinate

    # 校准模式
    def alignment_mode(self):
        self.ratio = 1
        center_pos = self.get_center_pos()

        step_size = 100
        while True:  # 判断鼠标是否在边缘，或找不到鼠标位置
            self.swipe(center_pos, [center_pos[0], center_pos[1] + step_size])


if __name__ == '__main__':
    test = AndroidComfuc("emulator-5554")
    # tep=[470,280]
    # test.click(tep)

    # 点击
    # keys=[
    #     [3,57,1], #序号
    #     [1,330,1],
    #     [3, 53, 47],#x
    #     [3, 54, 492],# y
    #     [0, 0, 0],
    #     [3, 57, -1],
    #     [1, 330, 0],
    #     [0, 0, 0],
    # ]

    key = [
        [3, 47, 0],
        [3, 57, 226],
        [1, 330, 1],
        [3, 58, 1],
        [3, 53, 485],
        [3, 54, 274],
        [0, 0, 0],
        [3, 54, 292],
        [0, 0, 0],
        [3, 54, 29],
        [0, 0, 0],
        [3, 54, 291],
        [0, 0, 0],
        [3, 54, 294],
        [0, 0, 0],
        [3, 54, 298],
        [0, 0, 0],
        [3, 53, 492],
        [3, 54, 301],
        [0, 0, 0],
        [3, 54, 305],
        [0, 0, 0],
        [3, 54, 309],
        [0, 0, 0],
        [3, 53, 490],
        [3, 54, 310],
        [0, 0, 0],
        [3, 54, 312],
        [0, 0, 0],
        [3, 54, 316],
        [0, 0, 0],
        [3, 54, 319],
        [0, 0, 0],
        [3, 54, 321],
        [0, 0, 0],
        [3, 54, 325],
        [0, 0, 0],
        [3, 54, 327],
        [0, 0, 0],
        [3, 54, 330],
        [0, 0, 0],
        [3, 54, 334],
        [0, 0, 0],
        [3, 53, 472],
        [3, 54, 339],
        [0, 0, 0],
        [3, 54, 341],
        [0, 0, 0],
        [3, 53, 470],
        [3, 54, 344],
        [0, 0, 0],
        [3, 54, 346],
        [0, 0, 0],
        [3, 54, 350],
        [0, 0, 0],
        [3, 54, 352],
        [0, 0, 0],
        [3, 53, 468],
        [3, 54, 353],
        [0, 0, 0],
        [3, 54, 355],
        [0, 0, 0],
        [3, 54, 359],
        [0, 0, 0],
        [3, 53, 467],
        [3, 54, 362],
        [0, 0, 0],
        [3, 54, 366],
        [0, 0, 0],
        [3, 54, 370],
        [0, 0, 0],
        [3, 53, 465],
        [3, 54, 377],
        [0, 0, 0],
        [3, 53, 463],
        [3, 54, 380],
        [0, 0, 0],
        [3, 53, 461],
        [3, 54, 388],
        [0, 0, 0],
        [3, 53, 459],
        [3, 54, 395],
        [0, 0, 0],
        [3, 53, 458],
        [3, 54, 402],
        [0, 0, 0],
        [3, 53, 456],
        [3, 54, 407],
        [0, 0, 0],
        [3, 53, 454],
        [3, 54, 413],
        [0, 0, 0],
        [3, 54, 416],
        [0, 0, 0],
        [3, 54, 420],
        [0, 0, 0],
        [3, 53, 468],
        [3, 54, 423],
        [0, 0, 0],
        [3, 54, 427],
        [0, 0, 0],
        [3, 54, 429],
        [0, 0, 0],
        [3, 54, 432],
        [0, 0, 0],
        [3, 54, 434],
        [0, 0, 0],
        [3, 54, 436],
        [0, 0, 0],
        [3, 54, 438],
        [0, 0, 0],
        [3, 54, 441],
        [0, 0, 0],
        [3, 54, 443],
        [0, 0, 0],
        [3, 54, 445],
        [0, 0, 0],
        [3, 54, 449],
        [0, 0, 0],
        [3, 54, 450],
        [0, 0, 0],
        [3, 54, 452],
        [0, 0, 0],
        [3, 54, 454],
        [0, 0, 0],
        [3, 54, 456],
        [0, 0, 0],
        [3, 54, 459],
        [0, 0, 0],
        [3, 54, 461],
        [0, 0, 0],
        [3, 54, 465],
        [0, 0, 0],
        [3, 54, 466],
        [0, 0, 0],
        [3, 54, 468],
        [0, 0, 0],
        [3, 54, 472],
        [0, 0, 0],
        [3, 54, 474],
        [0, 0, 0],
        [3, 54, 477],
        [0, 0, 0],
        [3, 54, 479],
        [0, 0, 0],
        [3, 54, 481],
        [0, 0, 0],
        [3, 54, 483],
        [0, 0, 0],
        [3, 54, 484],
        [0, 0, 0],
        [3, 54, 486],
        [0, 0, 0],
        [3, 54, 488],
        [0, 0, 0],
        [3, 53, 454],
        [0, 0, 0],
        [3, 54, 492],
        [0, 0, 0],
        [3, 54, 497],
        [0, 0, 0],
        [3, 54, 501],
        [0, 0, 0],
        [3, 54, 502],
        [0, 0, 0],
        [3, 53, 456],
        [3, 54, 504],
        [0, 0, 0],
        [3, 54, 506],
        [0, 0, 0],
        [3, 54, 508],
        [0, 0, 0],
        [3, 54, 511],
        [0, 0, 0],
        [3, 54, 513],
        [0, 0, 0],
        [3, 54, 515],
        [0, 0, 0],
        [3, 54, 517],
        [0, 0, 0],
        [3, 53, 458],
        [3, 54, 520],
        [0, 0, 0],
        [3, 54, 522],
        [0, 0, 0],
        [3, 54, 524],
        [0, 0, 0],
        [3, 53, 459],
        [0, 0, 0],
        [3, 54, 526],
        [0, 0, 0],
        [3, 53, 461],
        [0, 0, 0],
        [3, 54, 527],
        [0, 0, 0],
        [3, 53, 463],
        [0, 0, 0],
        [3, 53, 465],
        [0, 0, 0],
        [3, 54, 529],
        [0, 0, 0],
        [3, 54, 531],
        [0, 0, 0],
        [3, 54, 533],
        [0, 0, 0],
        [3, 54, 535],
        [0, 0, 0],
        [3, 54, 536],
        [0, 0, 0],
        [3, 57, -1],
        [1, 330, 0],
        [0, 0, 0],
    ]



    for i in key:
        test.send_keyevent(i)